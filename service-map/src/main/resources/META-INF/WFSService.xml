<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="WFSService">
    
    <!-- Use type aliases to avoid typing the full classname every time. -->
    <typeAlias alias="WFSService" type="fi.nls.oskari.domain.map.wfs.WFSService" />
    <typeAlias alias="OwsOperation" type="fi.nls.oskari.domain.map.wfs.OwsOperation" />
    <typeAlias alias="FeatureType" type="fi.nls.oskari.domain.map.wfs.FeatureType" />
    <typeAlias alias="FeatureParameter" type="fi.nls.oskari.domain.map.wfs.FeatureParameter" />
    <typeAlias alias="WFSLayerStyle" type="fi.nls.oskari.domain.map.wfs.WFSSLDStyle" />


    <resultMap id="wfsServiceResult" class="WFSService">
        <result property="id" column="id" />
        <result property="titleFi" column="title_fi" />
        <result property="titleSv" column="title_sv" />
        <result property="titleEn" column="title_en" />
        <result property="owsAbstractFi" column="abstract_fi" />
        <result property="owsAbstractSv" column="abstract_sv" />
        <result property="owsAbstractEn" column="abstract_en" />
        <result property="url" column="url" />        
        <result property="username" column="username" />
        <result property="password" column="password" />
        <result property="gmlVersion" column="gml_version" />
        <result property="useProxy" column="use_proxy" />
        <result property="geonetworkFileIdentifier" column="geonetwork_file_id" />
		<result property="gml2typeSeparator" column="gml2type_separator" />
    </resultMap>
    
    <resultMap id="featureTypeResult" class="FeatureType">
        <result property="id" column="id" />
        <result property="wfsService.id" column="wfs_service_id" />
        <result property="qname.prefix" column="name_prefix" />
        <result property="qname.localPart" column="name_local_part" />
        <result property="qname.namespaceURI" column="namespace_uri" />
        <result property="wfsTitleFi" column="title_fi" />
        <result property="wfsTitleSv" column="title_sv" />
        <result property="wfsTitleEn" column="title_en" />
        <result property="schemaLocation" column="schema_location" />
        <result property="bboxParameterName" column="bbox_parameter" />
        <result property="licenseJson" column="license_json" />
    </resultMap>
    
    <resultMap id="featureParameterResult" class="FeatureParameter">
        <result property="id" column="id" />
        <result property="featureType.id" column="feature_type_id" />
        <result property="qname.prefix" column="name_prefix" />
        <result property="qname.localPart" column="name_local_part" />
        <result property="qname.namespaceURI" column="namespace_uri" />
        <result property="featureParameterType" column="feature_parameter_type" />
        <result property="xmlType" column="xml_type" />
        <result property="converterType" column="converter_type" />
        <result property="bboxQueryParameter" column="bbox_query_parameter" />
    </resultMap>
    
    <resultMap id="owsOperationResult" class="OwsOperation">
        <result property="id" column="id" />
        <result property="wfsService.id" column="wfs_service_id" />
        <result property="name" column="name" />
        <result property="url" column="url" />
    </resultMap>

    <resultMap id="WFSLayerStyle" class="WFSLayerStyle" >
        <result property="id" column="id" />
        <result property="name" column="name" />
        <result property="sldStyle" column="sld_style" />
    </resultMap>
    
    <select id="maxId" resultClass="int">
        select max(id) from portti_wfs_service
    </select>
    
    <select id="maxIdFeatureType" resultClass="int">
        select max(id) from portti_feature_type
    </select>
    
    <select id="find" resultMap="wfsServiceResult" parameterClass="int">
        SELECT id, title_fi, title_sv, title_en, abstract_fi, abstract_sv, abstract_en, 
       url, username, password, gml_version, use_proxy, geonetwork_file_id, 
       gml2type_separator
  FROM portti_wfs_service where id=#id#
    </select>
    
    <select id="findAll" resultMap="wfsServiceResult">
        SELECT id, title_fi, title_sv, title_en, abstract_fi, abstract_sv, abstract_en, 
       url, username, password, gml_version, use_proxy, geonetwork_file_id, 
       gml2type_separator
  FROM portti_wfs_service order by title_fi
    </select>
    
    <select id="findFeatureTypesOfWFSService" resultMap="featureTypeResult">
        select id, wfs_service_id, namespace_uri, name_local_part, name_prefix, title_fi, title_sv, title_en, schema_location, bbox_parameter, license_json
        from portti_feature_type
        where wfs_service_id=#id#
        order by title_fi
    </select>
    
    <select id="findFeatureParametersOfWFSService" resultMap="featureParameterResult">
        select p.id, p.feature_type_id, p.namespace_uri, p.name_local_part, 
        p.name_prefix, p.feature_parameter_type, 
        p.xml_type, p.converter_type, p.bbox_query_parameter
        from portti_feature_type t, portti_feature_parameter p
        where t.id=p.feature_type_id 
        and t.wfs_service_id=#id#
        order by p.namespace_uri, p.name_prefix, name_local_part
    </select>
    
    <select id="findOwsOperationsOfWFSService" resultMap="owsOperationResult">
        select id, wfs_service_id, name, url
        from portti_ows_operation
        where wfs_service_id=#id#
        order by name
    </select>

    <select id="findLayerStyles" resultMap="WFSLayerStyle">
        select s.id, s.name, s.sld_style
        from  portti_wfs_layer_style s, portti_wfs_layers_styles m, portti_wfs_layer l
        where m.wfs_layer_id = l.id and l.maplayer_id = #id#
        and m.wfs_layer_style_id = s.id
    </select>

    <statement id="insert" parameterClass="WFSService" resultClass="int">
        insert into portti_wfs_service (
            title_fi, title_sv, title_en, abstract_fi, abstract_sv, 
            abstract_en, url, username, password, gml_version, use_proxy, geonetwork_file_id)
        values (
            #titleFi#, #titleSv#, #titleEn#, #owsAbstractFi#, #owsAbstractSv#, 
            #owsAbstractEn#, #url#, #username#, #password#, #gmlVersion#, #useProxy#, #geonetworkFileIdentifier#)
    </statement>
    
    <statement id="update" parameterClass="WFSService">
        update portti_wfs_service 
        set title_fi=#titleFi#, title_sv=#titleSv#, title_en=#titleEn#, 
            abstract_fi=#owsAbstractFi#, abstract_sv=#owsAbstractSv#, abstract_en=#owsAbstractEn#,
            url=#url#, username=#username#, password=#password#, gml_version=#gmlVersion#, 
            use_proxy=#useProxy#, geonetwork_file_id=#geonetworkFileIdentifier#
        where id=#id#
    </statement>
    
    <statement id="insertFeatureTypes" parameterClass="FeatureType">
        insert into portti_feature_type 
            (wfs_service_id, namespace_uri, name_local_part, name_prefix, 
            title_fi, title_sv, title_en, schema_location, bbox_parameter) 
        values 
            (#wfsService.id#, #qname.namespaceURI#, #qname.localPart#, #qname.prefix#, 
            #wfsTitleFi#, #wfsTitleSv#, #wfsTitleEn#, #schemaLocation#, #bboxParameterName#)
    </statement>
    
    <statement id="insertFeatureParametersWithParentId" parameterClass="FeatureParameter">
        insert into portti_feature_parameter 
            (feature_type_id, namespace_uri, name_local_part, name_prefix, feature_parameter_type, 
            xml_type, converter_type, bbox_query_parameter, parent_id) 
        values 
            (#featureType.id#, #qname.namespaceURI#, #qname.localPart#, #qname.prefix#, 
            #featureParameterType#, #xmlType#, #converterType#, #bboxQueryParameter#, #parentId#)
    </statement>
    
    <statement id="insertFeatureParametersNoParentId" parameterClass="FeatureParameter">
        insert into portti_feature_parameter 
            (feature_type_id, namespace_uri, name_local_part, name_prefix, feature_parameter_type, 
            xml_type, converter_type, bbox_query_parameter) 
        values 
            (#featureType.id#, #qname.namespaceURI#, #qname.localPart#, #qname.prefix#, 
            #featureParameterType#, #xmlType#, #converterType#, #bboxQueryParameter#)
    </statement>
    
    <statement id="insertOwsOperations" parameterClass="OwsOperation">
        insert into portti_ows_operation (wfs_service_id, name, url) 
        values (#wfsService.id#, #name#, #url#)
    </statement>
    
    <statement id="delete" parameterClass="int">
        delete from portti_wfs_service where id=#id#
    </statement>
    
    <statement id="deleteFeatureParameters" parameterClass="int">
        delete from portti_feature_parameter where feature_type_id in 
            (select id from portti_feature_type where wfs_service_id=#id#)
    </statement>
    
    <statement id="deleteFeatureTypes" parameterClass="int">
        delete from portti_feature_type where wfs_service_id=#id#
    </statement>
    
    <statement id="deleteOwsOperations" parameterClass="int">
        delete from portti_ows_operation where wfs_service_id=#id#
    </statement>
    
</sqlMap>