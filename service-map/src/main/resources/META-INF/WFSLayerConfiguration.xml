<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="WFSLayerConfiguration">

    <typeAlias alias="WFSLayerConfiguration" type="fi.nls.oskari.domain.map.wfs.WFSLayerConfiguration" />
    <typeAlias alias="WFSSLDStyle" type="fi.nls.oskari.domain.map.wfs.WFSSLDStyle" />
    
    <resultMap class="WFSLayerConfiguration" id="WFSLayerConfiguration">
        <result property="id" column="id"/>
        <result property="layerId" column="maplayer_id"/>
        <result property="URL" column="url"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>

        <result property="layerName" column="name"/>

        <result property="SRSName" column="srs_name"/>
        <result property="GMLVersion" column="gml_version"/>
        <result property="GML2Separator" column="gml2_separator"/>
        <result property="geometryNamespaceURI" column="geometry_namespace_uri"/>

        <result property="geometryType" column="geometry_type"/>

		<result property="minScale" column="minscale"/>
		<result property="maxScale" column="maxscale"/>
        <result property="attributes" column="attributes" jdbcType="VARCHAR" javaType="org.json.JSONObject"/>
        <result property="capabilities" column="capabilities" jdbcType="VARCHAR" javaType="org.json.JSONObject"/>

		<result property="selectionSLDStyle" column="selection_sld_style"/>
    </resultMap>


    <parameterMap id="LayerInsertParameter" class="WFSLayerConfiguration">
       <parameter property="layerId"/>
       <parameter property="layerName"/>
       <parameter property="GMLGeometryProperty"/>
       <parameter property="GMLVersion"/>
       <parameter property="GML2Separator"/>
       <parameter property="featureNamespace"/>
       <parameter property="featureNamespaceURI"/>
       <parameter property="geometryNamespaceURI"/>
       <parameter property="featureElement"/>
    </parameterMap>

    <parameterMap id="LayerUpdateParameter" class="WFSLayerConfiguration">
        <parameter property="GMLVersion"/>
        <parameter property="maxFeatures"/>
        <parameter property="id"/>

    </parameterMap>


    <resultMap class="WFSSLDStyle" id="WFSSLDStyle">
		<result property="id" column="sid"/>
		<result property="name" column="s_name"/>
		<result property="SLDStyle" column="sld_style"/>
    </resultMap>

    <select id="maxId" resultClass="int">
        select max(id) from portti_wfs_layer
    </select>

    <select id="findLayer" parameterClass="int" resultMap="WFSLayerConfiguration">
    	SELECT
    	    l.id,
			l.maplayer_id,
			map.url,
			map.username,
			map.password,
            map.name,
  			map.srs_name,
			l.gml_version,
            l.gml2_separator,
			map.version,

            l.geometry_namespace_uri,

			l.geometry_type,
			
			map.minscale,
			map.maxscale,

  			map.attributes,
            map.capabilities,
  			
  			ss.sld_style as selection_sld_style
  			
		FROM portti_wfs_layer l
		JOIN oskari_maplayer map ON map.id = l.maplayer_id
		LEFT OUTER JOIN portti_wfs_layer_style ss ON ss.id = l.selection_sld_style_id
		WHERE l.maplayer_id = #id#
    </select>

    <select id="findStylesForLayer" parameterClass="int" resultMap="WFSSLDStyle">
    	SELECT
  			s.id as sid,
  			s.name as s_name,
  			s.sld_style
  			
		FROM portti_wfs_layer l
		LEFT OUTER JOIN portti_wfs_layers_styles ls ON ls.wfs_layer_id = l.id
		LEFT OUTER JOIN portti_wfs_layer_style s ON s.id = ls.wfs_layer_style_id
		WHERE l.maplayer_id = #id#
    </select>

    <select id="findParserConfigs" parameterClass="string" resultMap="WFSParserConfig">
        SELECT
        *
        FROM oskari_wfs_parser_config
    </select>
    <statement id="delete" parameterClass="java.lang.Long">
        delete from portti_wfs_layer where maplayer_id=#maplayer_id#;
    </statement>

    <statement id="update" parameterMap="LayerUpdateParameter">
        <!--  TODO: decide what is allowed to edit -->
        UPDATE portti_wfs_layer
        SET
        gml_version = ?,
        max_features = ?
        WHERE id = ?
    </statement>

    <statement id="insertTemplateModel" parameterClass="java.util.Map" resultClass="java.lang.Integer" >
        insert into portti_wfs_template_model (
        name,
        description,
        type,
        request_template,
        response_template,
        parse_config)
        values (#name#, #description#, #type#, #request_template#, #response_template#, #parse_config#)
        returning id
    </statement>

    <statement id="insertLayerSLDStyles" parameterClass="java.util.Map" resultClass="java.lang.Integer" >
        insert into portti_wfs_layers_styles (
        wfs_layer_id,
        wfs_layer_style_id)
        values (#id#, #sld_style_id#)
        returning id
    </statement>


    <delete id="removeLayerSLDStyles" parameterClass="int">
        delete from portti_wfs_layers_styles where wfs_layer_id  = #id#;
    </delete>


    <!-- TODO: verify these works as OskariLayer refactoring effort is ongoing - portti_wfs_layer_style management is in SldStylesHandler
    <statement id="insertSLDStyle" parameterClass="java.util.Map" resultClass="java.lang.Integer" >
        insert into portti_wfs_layer_style (
        name,
        sld_style)
        values (#name#,#sld_style#)
        returning id
    </statement>

    <statement id="updateSLDStyle" parameterClass="java.util.Map" >
        UPDATE portti_wfs_layer_style
        SET
        name = #name#,
        sld_style = #sld_style#
        WHERE id = #id#
    </statement>
    -->
</sqlMap>